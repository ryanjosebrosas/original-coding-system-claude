#!/bin/bash
#
# Post-push hook: Automatically create PR when pushing feature branches
#
# Installation:
#   ln -sf ../../.githooks/post-push .git/hooks/post-push
#   chmod +x .git/hooks/post-push
#
# Or use: git config core.hooksPath .githooks

# Colors for output
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
NC='\033[0m' # No Color

# Get current branch
CURRENT_BRANCH=$(git branch --show-current)

# Get base branch (master or main)
BASE_BRANCH=$(git remote show origin 2>/dev/null | grep 'HEAD branch' | cut -d' ' -f5)
if [ -z "$BASE_BRANCH" ]; then
  BASE_BRANCH="master"
fi

# Check if gh CLI is available
if ! command -v gh &> /dev/null; then
  echo -e "${YELLOW}âš  GitHub CLI (gh) not found. Skipping PR creation.${NC}"
  echo "  Install: https://cli.github.com/"
  exit 0
fi

# Skip if we're on the base branch
if [ "$CURRENT_BRANCH" = "$BASE_BRANCH" ] || [ "$CURRENT_BRANCH" = "main" ] || [ "$CURRENT_BRANCH" = "master" ]; then
  exit 0
fi

# Only create PRs for feature branches (feat/, fix/, docs/, refactor/, chore/, etc.)
if [[ ! "$CURRENT_BRANCH" =~ ^(feat|fix|docs|refactor|chore|test|ci|perf|build|style)/.*$ ]] && \
   [[ ! "$CURRENT_BRANCH" =~ ^feature/.*$ ]]; then
  echo -e "${YELLOW}âš  Not a feature branch (${CURRENT_BRANCH}). Skipping PR creation.${NC}"
  echo "  Supported prefixes: feat/, fix/, docs/, refactor/, chore/, test/, ci/, perf/, build/, style/, feature/"
  exit 0
fi

# Check if PR already exists for this branch
EXISTING_PR=$(gh pr list --head "$CURRENT_BRANCH" --json number --jq '.[0].number' 2>/dev/null)

if [ -n "$EXISTING_PR" ]; then
  PR_URL=$(gh pr view "$EXISTING_PR" --json url --jq '.url' 2>/dev/null)
  echo -e "${GREEN}âœ“ PR already exists: #${EXISTING_PR}${NC}"
  echo -e "  ${PR_URL}"
  exit 0
fi

# Generate PR title from branch name
# feat/user-auth -> feat: user auth
# fix/login-bug -> fix: login bug
PR_PREFIX=$(echo "$CURRENT_BRANCH" | cut -d'/' -f1)
PR_TITLE_BASE=$(echo "$CURRENT_BRANCH" | cut -d'/' -f2- | tr '-' ' ')

# Map common branch prefixes to conventional commit types
case "$PR_PREFIX" in
  feat|feature) PR_TYPE="feat" ;;
  fix) PR_TYPE="fix" ;;
  docs) PR_TYPE="docs" ;;
  refactor) PR_TYPE="refactor" ;;
  chore) PR_TYPE="chore" ;;
  test) PR_TYPE="test" ;;
  ci) PR_TYPE="ci" ;;
  perf) PR_TYPE="perf" ;;
  build) PR_TYPE="build" ;;
  style) PR_TYPE="style" ;;
  *) PR_TYPE="feat" ;;
esac

PR_TITLE="${PR_TYPE}: ${PR_TITLE_BASE}"

# Generate PR description from commits
COMMIT_COUNT=$(git log "$BASE_BRANCH"..HEAD --oneline 2>/dev/null | wc -l | tr -d ' ')
COMMITS=$(git log "$BASE_BRANCH"..HEAD --pretty=format:"- %s" 2>/dev/null)
FILES_CHANGED=$(git diff "$BASE_BRANCH"...HEAD --stat 2>/dev/null | tail -1)

PR_BODY=$(cat <<EOF
## Summary
Automated PR from branch \`${CURRENT_BRANCH}\`.

## Changes
${COMMITS}

## Stats
${FILES_CHANGED}

## Test Plan
- [ ] Review changes
- [ ] Run tests locally
- [ ] Verify functionality

---
ğŸ¤– Auto-created by post-push hook
EOF
)

# Create the PR
echo -e "${YELLOW}ğŸš€ Creating PR for ${CURRENT_BRANCH}...${NC}"

if gh pr create --title "$PR_TITLE" --body "$PR_BODY" --base "$BASE_BRANCH" 2>/dev/null; then
  NEW_PR=$(gh pr list --head "$CURRENT_BRANCH" --json number --jq '.[0].number' 2>/dev/null)
  PR_URL=$(gh pr view "$NEW_PR" --json url --jq '.url' 2>/dev/null)

  echo -e "${GREEN}âœ… Pull Request Created!${NC}"
  echo -e "  ğŸ“‹ PR #${NEW_PR}: ${PR_TITLE}"
  echo -e "  ğŸ”— ${PR_URL}"
  echo ""
  echo -e "${GREEN}Next steps:${NC}"
  echo "  - CodeRabbit will review automatically (if configured)"
  echo "  - Claude Code will auto-fix issues (if configured)"
  echo "  - Review and merge when ready"
else
  echo -e "${RED}âŒ Failed to create PR${NC}"
  echo "  You can create it manually: gh pr create"
fi

exit 0
