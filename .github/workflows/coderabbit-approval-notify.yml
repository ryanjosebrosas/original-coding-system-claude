name: Notify Ready for Review

# Notify user when CodeRabbit approves - human must manually merge
on:
  pull_request_review:
    types: [submitted]

# Prevent duplicate runs on the same PR
concurrency:
  group: notify-review-${{ github.event.pull_request.number }}
  cancel-in-progress: true

jobs:
  notify-ready:
    # Only run when CodeRabbit APPROVES the PR (no more suggestions)
    # This means all fixes have been applied and it's ready for human review
    if: |
      github.event_name == 'pull_request_review' &&
      github.event.review.user.login == 'coderabbitai[bot]' &&
      github.event.review.state == 'approved'

    runs-on: ubuntu-latest

    permissions:
      pull-requests: write

    steps:
      - name: Notify PR author for review
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = ${{ github.event.pull_request.number }};
            const prAuthor = '${{ github.event.pull_request.user.login }}';

            // Build notification message
            let message = 'âœ… **CodeRabbit approved this PR!** All review suggestions have been addressed.\n\n';
            message += `@${prAuthor} - This PR is ready for your review and approval.\n\n`;
            message += '**What to check:**\n';
            message += '- âœ… Review the changes in the "Files changed" tab\n';
            message += '- âœ… Verify all fixes make sense\n';
            message += '- âœ… Check that tests are passing\n';
            message += '- âœ… Ensure no unintended changes were made\n\n';
            message += '**When ready to merge:**\n';
            message += '- Click "Merge pull request" button, or\n';
            message += '- Run: `gh pr merge ' + prNumber + ' --squash`\n\n';
            message += '_ðŸ¤– Automated fixes applied by Claude Code based on CodeRabbit feedback._';

            await github.rest.issues.createComment({
              issue_number: prNumber,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: message
            });
