name: CodeRabbit Auto-Merge

# Trigger when CodeRabbit submits any review on a PR
on:
  pull_request_review:
    types: [submitted]

# Prevent duplicate runs on the same PR
concurrency:
  group: coderabbit-auto-merge-${{ github.event.pull_request.number }}
  cancel-in-progress: true

jobs:
  auto-merge:
    # Only run when CodeRabbit submits a review
    # Note: We don't filter by review state here - GitHub's auto-merge
    # will only merge when ALL branch protection requirements are met
    if: |
      github.event_name == 'pull_request_review' &&
      github.event.review.user.login == 'coderabbitai[bot]'

    runs-on: ubuntu-latest

    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Enable auto-merge
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PR_NUMBER="${{ github.event.pull_request.number }}"

          echo "Enabling auto-merge on PR #$PR_NUMBER..."

          # Enable auto-merge with squash strategy
          # This is idempotent - running multiple times is safe
          gh pr merge "$PR_NUMBER" \
            --auto \
            --squash \
            --repo ${{ github.repository }}

          echo "âœ“ Auto-merge enabled. PR will merge automatically when all checks pass."

      - name: Post confirmation comment
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = ${{ github.event.pull_request.number }};
            const reviewState = '${{ github.event.review.state }}';

            // Build informational message
            let message = 'ðŸ¤– **Auto-merge enabled** by CodeRabbit review.\n\n';
            message += 'This PR will merge automatically when:\n';
            message += '- âœ… All required status checks pass\n';
            message += '- âœ… Required approvals are received (if configured)\n';
            message += '- âœ… Branch is up to date (if strict mode enabled)\n';
            message += '- âœ… No merge conflicts exist\n\n';
            message += `CodeRabbit review state: \`${reviewState}\`\n\n`;
            message += '_To disable auto-merge, run:_ `gh pr merge --disable-auto` _or use the PR UI._';

            await github.rest.issues.createComment({
              issue_number: prNumber,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: message
            });
